@page "/stats"
@using MineSweeper.Components.Atoms
@using MineSweeper.Services
@inject AchievementService AchievementService
@implements IDisposable

<PageTitle>Statistics - MineSweeper</PageTitle>

<Container>
    <Card Variant="CardVariant.Primary">
        <SectionHeader Icon="ðŸ“Š" Title="Game Statistics" Size="SectionHeader.HeaderSize.Large" />

        <Grid Columns="1" TabletColumns="2" DesktopColumns="3" Gap="Grid.GridGap.Medium">
            <!-- Overall Performance -->
            <Card Variant="CardVariant.Secondary" Padding="CardPadding.Small" Hover="true">
                <SectionHeader Icon="ðŸŽ¯" Title="Overall Performance" Size="SectionHeader.HeaderSize.Small" />
                <Stack Direction="Stack.StackDirection.Column" Gap="Stack.StackGap.Medium">
                    <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                        <span class="text-gray-300">Total Games</span>
                        <span class="text-2xl font-bold text-white">@AchievementService.Statistics.TotalGamesPlayed</span>
                    </Stack>
                    <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                        <span class="text-gray-300">Wins</span>
                        <span class="text-2xl font-bold text-green-400">@AchievementService.Statistics.TotalWins</span>
                    </Stack>
                    <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                        <span class="text-gray-300">Losses</span>
                        <span class="text-2xl font-bold text-red-400">@AchievementService.Statistics.TotalLosses</span>
                    </Stack>
                    <div class="pt-3 border-t border-gray-600">
                        <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                            <span class="text-gray-300">Win Rate</span>
                            <span class="text-2xl font-bold @GetWinRateColor()">
                                @AchievementService.Statistics.WinRate.ToString("F1")%
                            </span>
                        </Stack>
                        <div class="mt-2 progress-bar">
                            <div class="progress-fill gradient-green"
                                 style="--progress-width: @AchievementService.Statistics.WinRate%"></div>
                        </div>
                    </div>
                </Stack>
            </Card>

            <!-- Streaks -->
            <Card Variant="CardVariant.Secondary" Padding="CardPadding.Small" Hover="true">
                <SectionHeader Icon="ðŸ”¥" Title="Win Streaks" Size="SectionHeader.HeaderSize.Small" />
                <Stack Direction="Stack.StackDirection.Column" Gap="Stack.StackGap.Medium">
                    <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                        <span class="text-gray-300">Current Streak</span>
                        <span class="text-3xl font-bold text-yellow-400">@AchievementService.Statistics.CurrentWinStreak</span>
                    </Stack>
                    <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                        <span class="text-gray-300">Best Streak</span>
                        <span class="text-3xl font-bold text-orange-400">@AchievementService.Statistics.BestWinStreak</span>
                    </Stack>
                    <div class="pt-3 border-t border-gray-600">
                        <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                            <span class="text-gray-300">Total Play Time</span>
                            <span class="text-lg font-mono text-white">@FormatPlayTime(AchievementService.Statistics.TotalPlayTime)</span>
                        </Stack>
                    </div>
                </Stack>
            </Card>

            <!-- Best Times -->
            <Card Variant="CardVariant.Secondary" Padding="CardPadding.Small" Hover="true">
                <SectionHeader Icon="â±ï¸" Title="Best Times" Size="SectionHeader.HeaderSize.Small" />
                <Stack Direction="Stack.StackDirection.Column" Gap="Stack.StackGap.Medium">
                    <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                        <Stack Direction="Stack.StackDirection.Row" Align="Stack.StackAlign.Center" Gap="Stack.StackGap.Small" Class="text-gray-300">
                            <span class="text-green-400">ðŸŒ±</span>
                            Beginner
                        </Stack>
                        <span class="font-mono text-xl text-white">
                            @(AchievementService.Statistics.BeginnerStats.BestTime.HasValue
                                ? FormatTime(AchievementService.Statistics.BeginnerStats.BestTime.Value)
                                : "--:--")
                        </span>
                    </Stack>
                    <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                        <Stack Direction="Stack.StackDirection.Row" Align="Stack.StackAlign.Center" Gap="Stack.StackGap.Small" Class="text-gray-300">
                            <span class="text-yellow-400">ðŸ”¥</span>
                            Intermediate
                        </Stack>
                        <span class="font-mono text-xl text-white">
                            @(AchievementService.Statistics.IntermediateStats.BestTime.HasValue
                                ? FormatTime(AchievementService.Statistics.IntermediateStats.BestTime.Value)
                                : "--:--")
                        </span>
                    </Stack>
                    <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between" Align="Stack.StackAlign.Center">
                        <Stack Direction="Stack.StackDirection.Row" Align="Stack.StackAlign.Center" Gap="Stack.StackGap.Small" Class="text-gray-300">
                            <span class="text-red-400">ðŸ’€</span>
                            Expert
                        </Stack>
                        <span class="font-mono text-xl text-white">
                            @(AchievementService.Statistics.ExpertStats.BestTime.HasValue
                                ? FormatTime(AchievementService.Statistics.ExpertStats.BestTime.Value)
                                : "--:--")
                        </span>
                    </Stack>
                </Stack>
            </Card>
        </Grid>

        <!-- Difficulty Breakdown -->
        <Grid Columns="1" TabletColumns="3" Gap="Grid.GridGap.Medium" Class="mt-6">
            @foreach (var (difficulty, stats, color, icon) in GetDifficultyData())
            {
                <Card Variant="CardVariant.Secondary" Padding="CardPadding.Small" Hover="true">
                    <SectionHeader Icon="@icon" Title="@difficulty" Size="SectionHeader.HeaderSize.ExtraSmall" />
                    <Stack Direction="Stack.StackDirection.Column" Gap="Stack.StackGap.Small" Class="text-sm">
                        <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between">
                            <span class="text-gray-400">Games Played</span>
                            <span class="text-white font-semibold">@stats.GamesPlayed</span>
                        </Stack>
                        <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between">
                            <span class="text-gray-400">Games Won</span>
                            <span class="text-white font-semibold">@stats.GamesWon</span>
                        </Stack>
                        <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between">
                            <span class="text-gray-400">Win Rate</span>
                            <span class="text-white font-semibold">
                                @(stats.GamesPlayed > 0 ? $"{(double)stats.GamesWon / stats.GamesPlayed * 100:F1}%" : "0%")
                            </span>
                        </Stack>
                        <Stack Direction="Stack.StackDirection.Row" Justify="Stack.StackJustify.Between">
                            <span class="text-gray-400">Average Time</span>
                            <span class="text-white font-mono">
                                @(stats.AverageTime.HasValue ? FormatTime(stats.AverageTime.Value) : "--:--")
                            </span>
                        </Stack>
                    </Stack>
                </Card>
            }
        </Grid>

        <!-- Fun Facts -->
        <Card Variant="CardVariant.Secondary" Padding="CardPadding.Small" Class="mt-6">
            <SectionHeader Icon="ðŸŽ²" Title="Fun Facts" Size="SectionHeader.HeaderSize.Small" Class="mb-5" />
            <Grid Columns="2" TabletColumns="4" Gap="Grid.GridGap.Medium">
                <div class="text-center">
                    <p class="text-3xl sm:text-4xl font-bold text-blue-400">@AchievementService.Statistics.TotalCellsRevealed</p>
                    <p class="text-sm text-gray-400 mt-1">Cells Revealed</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl sm:text-4xl font-bold text-purple-400">@AchievementService.Statistics.TotalFlagsPlaced</p>
                    <p class="text-sm text-gray-400 mt-1">Flags Placed</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl sm:text-4xl font-bold text-green-400">@AchievementService.Statistics.LargestFirstClick</p>
                    <p class="text-sm text-gray-400 mt-1">Largest First Click</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl sm:text-4xl font-bold text-yellow-400">@AchievementService.Statistics.GamesWonWithoutFlags</p>
                    <p class="text-sm text-gray-400 mt-1">No-Flag Wins</p>
                </div>
            </Grid>
        </Card>

        @if (AchievementService.Statistics.LastPlayedAt.HasValue)
        {
            <p class="text-center text-gray-500 text-sm mt-5">
                Last played: @AchievementService.Statistics.LastPlayedAt.Value.ToString("MMM d, yyyy h:mm tt")
            </p>
        }
    </Card>
</Container>

@code {
    protected override void OnInitialized()
    {
        AchievementService.OnStatisticsUpdated += OnStatisticsUpdated;
    }

    private void OnStatisticsUpdated()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetWinRateColor()
    {
        return AchievementService.Statistics.WinRate switch
        {
            >= 75 => "text-green-400",
            >= 50 => "text-yellow-400",
            >= 25 => "text-orange-400",
            _ => "text-red-400"
        };
    }

    private List<(string Name, DifficultyStatistics Stats, string Color, string Icon)> GetDifficultyData()
    {
        return new()
        {
            ("Beginner", AchievementService.Statistics.BeginnerStats, "green", "ðŸŒ±"),
            ("Intermediate", AchievementService.Statistics.IntermediateStats, "yellow", "ðŸ”¥"),
            ("Expert", AchievementService.Statistics.ExpertStats, "red", "ðŸ’€")
        };
    }

    private string FormatTime(TimeSpan time)
    {
        return $"{(int)time.TotalMinutes:00}:{time.Seconds:00}";
    }

    private string FormatPlayTime(TimeSpan time)
    {
        if (time.TotalDays >= 1)
            return $"{(int)time.TotalDays}d {time.Hours}h";
        else if (time.TotalHours >= 1)
            return $"{(int)time.TotalHours}h {time.Minutes}m";
        else
            return $"{(int)time.TotalMinutes}m {time.Seconds}s";
    }

    public void Dispose()
    {
        AchievementService.OnStatisticsUpdated -= OnStatisticsUpdated;
    }
}